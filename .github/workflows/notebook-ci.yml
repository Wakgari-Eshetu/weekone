name: Notebook CI - Environment Check

on:
  push:
    branches: [ main, master, task-3, "**" ]
  pull_request:
    branches: [ main, master ]

jobs:
  smoke-check:
    name: Smoke check (install deps & import)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          else
            python -m pip install pandas numpy nltk textblob matplotlib seaborn scikit-learn wordcloud ipykernel nbformat
          fi

      - name: Download NLTK corpora (quiet)
        run: |
          python - <<'PY'
import nltk
for pkg in ('punkt','stopwords','wordnet'):
    try:
        nltk.data.find(f'tokenizers/{pkg}' if pkg=='punkt' else f'corpora/{pkg}')
    except LookupError:
        nltk.download(pkg, quiet=True)
print('NLTK data ensured')
PY

      - name: Quick import test
        run: |
          python - <<'PY'
import sys
import pandas as pd
import numpy as np
import nltk
from textblob import TextBlob
import matplotlib
import seaborn as sns
print('PYTHON:', sys.executable)
print('pandas', pd.__version__)
print('numpy', np.__version__)
print('nltk', nltk.__version__)
print('textblob OK')
PY

      - name: Validate notebooks (nbformat)
        run: |
          python - <<'PY'
import glob
import nbformat
from nbformat import validate, ValidationError
files = glob.glob('notebooks/*.ipynb')
errors = 0
for f in files:
    try:
        nb = nbformat.read(f, as_version=4)
        # basic validation
        validate(nb)
        print(f'VALID: {f}')
    except Exception as e:
        print(f'INVALID: {f} ->', e)
        errors += 1
if errors:
    raise SystemExit('Notebook validation failed')
PY

  run-notebooks-optional:
    name: (Optional) Execute notebooks with papermill
    runs-on: ubuntu-latest
    needs: smoke-check
    if: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install runtime deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          else
            python -m pip install papermill
          fi

      - name: Run Task 3 notebook via papermill
        run: |
          python - <<'PY'
import papermill as pm
pm.execute_notebook('notebooks/task3.ipynb','outputs/task3-output.ipynb')
print('task3 executed')
PY
